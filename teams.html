<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختيار الفريق - نظام إدارة البطولة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- إضافة Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #0a0a1a;
            color: white;
            min-height: 100vh;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 100, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 75% 75%, rgba(255, 50, 50, 0.1) 0%, transparent 20%);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        header h1 {
            color: #3b82f6;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 15px 25px;
            text-align: center;
            min-width: 150px;
        }
        
        .stat-box h3 {
            color: #94a3b8;
            margin-bottom: 5px;
            font-size: 1rem;
        }
        
        .stat-box .value {
            color: #3b82f6;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .instructions {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }
        
        .instructions h2 {
            color: #3b82f6;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .instructions ol {
            padding-right: 20px;
            line-height: 1.8;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .participant-form {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #334155;
            text-align: center;
        }
        
        .participant-form h2 {
            color: #3b82f6;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            border: 1px solid #334155;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.7);
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .team-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .team-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        
        .team-card.selected {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        
        .team-card.unavailable {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .team-card h3 {
            color: #e2e8f0;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .save-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 40px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        .btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
        }
        
        .selections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .selections-table th, .selections-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #334155;
        }
        
        .selections-table th {
            background: rgba(30, 41, 59, 0.8);
            color: #3b82f6;
            font-weight: bold;
        }
        
        .selections-table tr:last-child td {
            border-bottom: none;
        }
        
        .selections-table tr:hover {
            background: rgba(51, 65, 85, 0.3);
        }
        
        /* تنسيقات خاصة للمسؤول - مخفية بشكل افتراضي */
        .admin-panel {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
            display: none;
        }
        
        .admin-panel h2 {
            color: #f59e0b;
            margin-bottom: 20px;
        }
        
        .admin-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .admin-btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-btn {
            background: #10b981;
            color: white;
            border: none;
        }
        
        .export-btn:hover {
            background: #059669;
        }
        
        .reset-btn {
            background: #ef4444;
            color: white;
            border: none;
        }
        
        .reset-btn:hover {
            background: #dc2626;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: #94a3b8;
            padding: 20px;
            border-top: 1px solid #334155;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #3b82f6;
        }
        
        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .teams-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .admin-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>اختر فريقتك</h1>
            <div class="stats">
                <div class="stat-box">
                    <h3>المتبقي</h3>
                    <div class="value" id="remainingCount">32</div>
                </div>
                <div class="stat-box">
                    <h3>تم الاختيار</h3>
                    <div class="value" id="selectedCount">0</div>
                </div>
            </div>
        </header>
        
        <section class="instructions">
            <h2>كيفية الاستخدام:</h2>
            <ol>
                <li>أدخل اسمك في الحقل المخصص</li>
                <li>اختر الفريق الذي تريد من قائمة الفرق المتاحة</li>
                <li>اضغط على "احفظ الاختيار" لتأكيد</li>
                <li>سيظهر اسمك والفريق المختار في الجدول أدناه</li>
                <li>يمكن للجميع رؤية جميع الاختيارات في الجدول</li>
            </ol>
        </section>
        
        <section class="participant-form">
            <h2>اسم المشترك:</h2>
            <div class="input-group">
                <input type="text" id="participantName" placeholder="أدخل اسمك هنا">
            </div>
        </section>
        
        <div class="teams-grid" id="teamsContainer">
            <div class="loading">جاري تحميل الفرق...</div>
        </div>
        
        <div class="save-section">
            <button id="saveSelection" class="btn" disabled>احفظ الاختيار</button>
        </div>
        
        <!-- لوحة المسؤول - ستظهر فقط إذا كان الرابط يحتوي على параметر سري -->
        <div class="admin-panel" id="adminPanel">
            <h2><i class="fas fa-crown"></i> أدوات المسؤول</h2>
            <div class="admin-buttons">
                <button class="admin-btn export-btn" onclick="exportData()">
                    <i class="fas fa-file-export"></i> تصدير البيانات
                </button>
                <button class="admin-btn reset-btn" onclick="confirmReset()">
                    <i class="fas fa-eraser"></i> إعادة التعيين
                </button>
            </div>
        </div>
        
        <h2 style="color: #3b82f6; text-align: center; margin: 30px 0 20px;">قائمة الاختيارات:</h2>
        <div class="table-container">
            <table class="selections-table">
                <thead>
                    <tr>
                        <th>اسم المشترك</th>
                        <th>الفريق المختار</th>
                        <th>وقت التسجيل</th>
                    </tr>
                </thead>
                <tbody id="selectionsTableBody">
                    <tr>
                        <td colspan="3" style="text-align: center;">جاري تحميل البيانات...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <footer>
            <p>نظام إدارة البطولة © 2023 | جميع الحقوق محفوظة</p>
        </footer>
    </div>

    <script>
        // تكوين Firebase - إستخدم الإعدادات الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyC9RbJ8dH6CvpyYtgosXFKI5gJzkUJmrGs",
            authDomain: "team-picker-869aa.firebaseapp.com",
            projectId: "team-picker-869aa",
            storageBucket: "team-picker-869aa.firebasestorage.app",
            messagingSenderId: "635629828226",
            appId: "1:635629828226:web:8798646b64fa899f33dc9b",
            measurementId: "G-NMY4PSD41Z"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // بيانات الفرق - 32 فريقاً
        const teams = [
            "REAL MADRID", "ATLETICO MADRID", "FC BARCELONA", "VILLARREAL", "SEVILLA",
            "MAN UTD", "LIVERPOOL", "MANCITY", "TOTTENHAM", "NEWCASTLE UNITED",
            "ARSENAL", "CHELSEA", "AC MILAN", "INTER MILAN", "ROMA",
            "JUVENTUS", "NAPOLI", "BAYERN MUNCHEN", "LEVERKUSEN", "DORTMUND",
            "PSG", "MARSEILLE", "MONACO", "AL NASR", "AL HILAL",
            "SPORTING LISBON", "BENFICA", "AJAX", "PSV", "FLAMENGO",
            "RIVER PLATE", "NOTTINGHAM FOREST"
        ];
        
        // عناصر DOM
        const participantNameInput = document.getElementById('participantName');
        const saveButton = document.getElementById('saveSelection');
        const teamsContainer = document.getElementById('teamsContainer');
        const selectionsTableBody = document.getElementById('selectionsTableBody');
        const remainingCount = document.getElementById('remainingCount');
        const selectedCount = document.getElementById('selectedCount');
        const adminPanel = document.getElementById('adminPanel');
        
        // تهيئة البيانات
        let selections = [];
        let selectedTeam = null;
        
        // تحقق إذا كان رابط الصفحة يحتوي على المفتاح السري للمسؤول
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true') {
            adminPanel.style.display = 'block';
        }
        
        // تحميل البيانات من Firebase
        function loadSelections() {
            db.collection("selections").orderBy("timestamp", "desc")
                .onSnapshot((snapshot) => {
                    selections = [];
                    snapshot.forEach((doc) => {
                        selections.push(doc.data());
                    });
                    renderTeams();
                    updateStats();
                    renderSelectionsTable();
                }, (error) => {
                    console.error("Error loading data: ", error);
                    selectionsTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #ef4444;">خطأ في تحميل البيانات</td></tr>';
                });
        }
        
        // عرض الفرق
        function renderTeams() {
            teamsContainer.innerHTML = '';
            
            teams.forEach(team => {
                const isAvailable = !selections.some(selection => selection.team === team);
                
                const teamCard = document.createElement('div');
                teamCard.className = `team-card ${!isAvailable ? 'unavailable' : ''}`;
                teamCard.innerHTML = `<h3>${team}</h3>`;
                
                if (isAvailable) {
                    teamCard.addEventListener('click', () => selectTeam(team, teamCard));
                }
                
                teamsContainer.appendChild(teamCard);
            });
        }
        
        // اختيار فريق
        function selectTeam(team, card) {
            // إلغاء اختيار أي فريق سابق
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // اختيار الفريق الجديد
            selectedTeam = team;
            card.classList.add('selected');
            toggleSaveButton();
        }
        
        // تفعيل/تعطيل زر الحفظ
        function toggleSaveButton() {
            saveButton.disabled = !(participantNameInput.value.trim() && selectedTeam);
        }
        
        // حفظ الاختيار
        function saveSelection() {
            const name = participantNameInput.value.trim();
            
            if (!name || !selectedTeam) {
                alert('يرجى إدخال اسمك واختيار فريق!');
                return;
            }
            
            // التحقق إذا كان الاسم مستخدماً already
            if (selections.some(selection => selection.name.toLowerCase() === name.toLowerCase())) {
                alert('هذا الاسم مسجل مسبقاً، يرجى استخدام اسم آخر!');
                return;
            }
            
            // التحقق إذا كان الفريق محجوزاً already
            if (selections.some(selection => selection.team === selectedTeam)) {
                alert('هذا الفريق محجوز مسبقاً، يرجى اختيار فريق آخر!');
                return;
            }
            
            // إضافة الاختيار إلى Firebase
            const newSelection = {
                name: name,
                team: selectedTeam,
                timestamp: new Date().toISOString()
            };
            
            db.collection("selections").add(newSelection)
                .then(() => {
                    alert(`تم حفظ اختيارك بنجاح! فريقك: ${selectedTeam}`);
                    // إعادة تعيين الحقول
                    participantNameInput.value = '';
                    selectedTeam = null;
                    document.querySelectorAll('.team-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    toggleSaveButton();
                })
                .catch((error) => {
                    alert("حدث خطأ أثناء الحفظ: " + error.message);
                });
        }
        
        // تحديث الإحصائيات
        function updateStats() {
            remainingCount.textContent = 32 - selections.length;
            selectedCount.textContent = selections.length;
        }
        
        // عرض جدول الاختيارات
        function renderSelectionsTable() {
            selectionsTableBody.innerHTML = '';
            
            if (selections.length === 0) {
                selectionsTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center;">لا توجد اختيارات حتى الآن</td>
                    </tr>
                `;
                return;
            }
            
            selections.forEach(selection => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${selection.name}</td>
                    <td>${selection.team}</td>
                    <td>${new Date(selection.timestamp).toLocaleString('ar-SA')}</td>
                `;
                selectionsTableBody.appendChild(row);
            });
        }
        
        // تصدير البيانات (للمسؤول)
        function exportData() {
            if (selections.length === 0) {
                alert("لا توجد بيانات للتصدير!");
                return;
            }
            
            // تحويل البيانات إلى تنسيق CSV
            let csvContent = "اسم المشترك,الفريق المختار,وقت التسجيل\n";
            selections.forEach(selection => {
                csvContent += `"${selection.name}","${selection.team}","${new Date(selection.timestamp).toLocaleString('ar-SA')}"\n`;
            });
            
            // إنشاء ملف وتنزيله
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const date = new Date().toISOString().slice(0, 10);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `اختيارات_الفرق_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert("تم تصدير البيانات بنجاح!");
        }
        
        // تأكيد إعادة التعيين (للمسؤول)
        function confirmReset() {
            if (confirm("هل أنت متأكد من أنك تريد مسح جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء!")) {
                // حذف جميع المستندات من Firestore
                const batch = db.batch();
                const promises = [];
                
                db.collection("selections").get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        promises.push(db.collection("selections").doc(doc.id).delete());
                    });
                    
                    Promise.all(promises)
                        .then(() => {
                            alert("تم مسح جميع البيانات بنجاح!");
                        })
                        .catch((error) => {
                            alert("حدث خطأ أثناء مسح البيانات: " + error.message);
                        });
                });
            }
        }
        
        // تهيئة الصفحة عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            // إضافة event listeners
            participantNameInput.addEventListener('input', toggleSaveButton);
            saveButton.addEventListener('click', saveSelection);
            
            // تحميل البيانات من Firebase
            loadSelections();
        });
    </script>
</body>
</html>
